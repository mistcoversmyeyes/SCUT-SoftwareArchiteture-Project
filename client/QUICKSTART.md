# 图片预处理器快速开始指南

## 🚀 5分钟快速上手

> **新功能：** v1.1版本现在支持PDF文件预处理！



### 第一步：启动服务

确保OCR后端服务已启动：
```bash
cd python-infer/app
python main.py
```

后端应该运行在 `http://localhost:8090`

### 第二步：打开客户端

在浏览器中打开：
```
client/index.html
```

或使用HTTP服务器：
```bash
cd client
python -m http.server 8000
# 然后访问 http://localhost:8000
```

### 第三步：测试预处理器

1. **查看状态**
   - 打开页面后，找到"🎨 图片预处理设置"面板
   - 确认状态显示为"已启用"
   - 检查浏览器控制台，应该看到：
     ```
     ✓ WebGPU已启用，图片处理将使用GPU加速
     ✓ 图片预处理器已加载
     ```

2. **上传测试文件**
   - 在"基础文本识别（OCRv5）"部分选择图片
   - 或在"文档结构解析"部分选择PDF文件
   - 建议选择>1MB的大文件以查看压缩效果
   - 点击"开始识别"或"开始解析"

3. **观察处理过程**
   - 会显示预处理进度条
   - 显示预处理统计信息
   - 然后自动上传并返回OCR结果

## 📊 预期结果示例

### 场景1：大文件压缩

**输入**：5MB的高分辨率截图（3840x2160）
```
✓ 图片预处理完成
原始大小: 5120KB          处理后: 820KB
原始尺寸: 3840x2160       处理后: 2048x1152
压缩比: 6.24x             处理时间: 650ms
应用增强: 对比度增强, 锐化(0.3)
```

### 场景2：小文件跳过

**输入**：200KB的普通图片（800x600）
```
ℹ 图片符合最佳标准
原始大小: 195KB
```

### 场景3：低质量图片增强

**输入**：600KB的模糊扫描件（1200x1600）
```
✓ 图片预处理完成
原始大小: 587KB           处理后: 425KB
原始尺寸: 1200x1600       处理后: 1200x1600
压缩比: 1.38x             处理时间: 320ms
应用增强: 对比度增强, 锐化(0.3)
```

### 场景4：PDF文档压缩（新增）

**输入**：8MB的多页PDF文档（15页）
```
✓ PDF预处理完成
原始大小: 8192KB         处理后: 3250KB
页数: 15页               压缩比: 2.52x
处理时间: 8500ms         渲染比例: 1.5
```

## 🎯 最佳实践

### 1. 选择合适的质量设置

**文档类型**：质量0.92（默认）
- 文字清晰
- 文件大小合理
- 适合大多数场景

**照片类型**：质量0.85
- 更小的文件
- 更快的上传速度
- 识别效果依然良好

### 2. 何时禁用预处理器

在以下情况下可以禁用：
- ❌ 已经是优化过的图片
- ❌ 对原始图片有特殊要求
- ❌ 测试对比效果

### 3. 调整高级参数

根据您的需求调整：

**快速模式**（牺牲一点质量换取速度）：
```
最大宽度: 1600
最大高度: 1600
质量: 0.85
最大文件大小: 800KB
锐化: 关闭
对比度: 关闭
```

**极致质量模式**（适用于重要文档）：
```
最大宽度: 3072
最大高度: 3072
质量: 0.95
最大文件大小: 2048KB
锐化: 开启
对比度: 开启
```

## 📄 PDF处理说明

### PDF预处理触发条件

- 文件大小 > 3MB（PDF阈值是图片的3倍）
- 页数 > 20页

### PDF处理流程

1. **检测PDF**：自动识别PDF文件
2. **分析页数**：提取页数和文件大小信息
3. **渲染页面**：将每页转换为高质量图片
4. **优化图片**：应用图片优化算法
5. **重新打包**：组合成优化后的PDF

### 注意事项

- PDF处理比图片慢，大型PDF可能需要10-15秒
- 如果jsPDF库未加载，会自动降级为提取首页图片
- 建议对20页以内的PDF进行预处理
- 超大PDF（>50页）建议直接上传

## 🔍 问题排查

### 预处理器未加载

**症状**：控制台显示 `⚠ 图片预处理器未加载` 或 `PDF.js未加载`

**解决方案**：
1. 检查 `imagePreprocessor.js` 是否存在
2. 检查HTML中的脚本引用顺序：
   ```html
   <!-- PDF处理库 -->
   <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
   <script src="./imagePreprocessor.js"></script>
   <script src="./main.js" defer></script>
   ```
3. 确保网络连接正常，可以访问CDN

### WebGPU不可用

**症状**：控制台显示 `WebGPU不可用，使用Canvas API处理`

**这是正常的！** 预处理器会自动降级到Canvas API，功能完全正常，只是速度略慢一些。

如果想启用WebGPU：
1. 使用Chrome 113+
2. 在 `chrome://flags` 中搜索 "WebGPU"
3. 启用 "Unsafe WebGPU" 选项
4. 重启浏览器

### 预处理失败

**症状**：显示 `⚠ 预处理失败: [错误信息]`

**不用担心！** 预处理失败时会自动使用原始文件继续上传，不会影响OCR功能。

## 📱 移动端支持

预处理器在移动设备上也能正常工作：

- ✅ iOS Safari 14+
- ✅ Android Chrome 90+
- ⚠️ 处理速度可能较慢
- ⚠️ 建议降低最大尺寸参数（如1600x1600）

## 🎨 自定义样式

如果您想自定义预处理器的UI样式，可以在 `styles.css` 中修改：

```css
/* 修改进度条颜色 */
.progress-fill {
  background: linear-gradient(90deg, #your-color-1, #your-color-2);
}

/* 修改成功信息背景 */
.preprocessing-success {
  background: #your-background-color;
}
```

## 📖 更多信息

- 详细文档：`PREPROCESSOR_README.md`
- API参考：查看 `imagePreprocessor.js` 中的注释
- 问题反馈：联系开发团队

## 🎉 开始使用

现在您已经了解了基础知识，开始上传您的第一张图片吧！

记住：
1. ✅ 预处理器默认已启用
2. ✅ 自动判断是否需要处理
3. ✅ 失败时自动使用原始文件
4. ✅ 完全在客户端处理，安全可靠

祝您使用愉快！🎊

